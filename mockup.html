<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SARIMAX Dashboard: Look Back, Overlap, Bar Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: #f8f9fa; }

    .chart-container {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 2rem;
    }

    .color-box { width: 16px; height: 16px; display:inline-block; border-radius: 3px; vertical-align: middle;}
    .ac-color { background: #0d6efd;}
    .forecast-past-color { background: #dc3545;}
    .fc-color { background: orange;}
    .prev-color { background: #198754;}
    .custom-legend span { display: inline-block; margin-right: 2em;}

    .dashboard-header .dashboard-title {
      font-weight: 800;
      letter-spacing: 1px;
      font-size: 2rem;
      line-height: 1.1;
    }
    .dashboard-header .dashboard-date {
      font-size: 1.1rem;
      opacity: 0.85;
    }
    .nav-arrow {
      font-size: 2rem;
      text-decoration: none;
      color: #111;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.35rem 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .summary-row:last-child { border-bottom: 0; }

    .ranking-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }
    .pill {
      display: inline-block;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.85rem;
      white-space: nowrap;
    }
    .kwh-pill { background: #d1f2e5; }
    .php-pill { background: #f6d6d6; }

    .h-100 { height: 100%; }

    .chart-area { height: 260px; }
    .chart-area canvas { width: 100% !important; height: 100% !important; }

    .status-dot{
      width:10px;height:10px;border-radius:50%;
      display:inline-block;vertical-align:middle;margin-right:6px;
      background:#fd7e14;
    }
  </style>
</head>

<body>
  <div class="container py-5">

    <div class="dashboard-header text-center mb-4">
      <div class="d-flex justify-content-center align-items-center gap-3">
        <button class="btn btn-link nav-arrow p-0">&lt;</button>
        <div>
          <div class="dashboard-title">DASHBOARD</div>
          <div class="dashboard-date">November 1, 2025</div>
        </div>
        <button class="btn btn-link nav-arrow p-0">&gt;</button>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-lg-8">
        <div class="chart-container h-100">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <h4 class="m-0">Actual VS Forecast</h4>

            <div class="d-flex align-items-center gap-3">
              <div class="d-flex align-items-center gap-2">
                <span class="small fw-semibold">All-time</span>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input" type="checkbox" checked>
                </div>
              </div>

              <div class="d-flex align-items-center gap-2">
                <span class="small fw-semibold">Filter</span>
                <select class="form-select form-select-sm" style="width:auto;">
                  <option selected>Electric Fan</option>
                  <option>Rice Cooker</option>
                  <option>Television</option>
                </select>
              </div>
            </div>
          </div>

          <div class="chart-area mt-3">
            <canvas id="energyLineChart"></canvas>
          </div>

          <div class="custom-legend mt-2">
            <span><span class="color-box ac-color"></span> Actual</span>
            <span><span class="color-box fc-color"></span> Forecast</span>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="chart-container h-100">
          <h4 class="m-0">Previous VS Forecasted</h4>

          <div class="chart-area mt-3">
            <canvas id="energyBarChart"></canvas>
          </div>

          <div class="custom-legend mt-2">
            <span><span class="color-box prev-color"></span> Previous</span>
            <span><span class="color-box fc-color"></span> Forecasted</span>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card p-3 h-100">
          <h5 class="mb-3">Forecast Controls</h5>

          <div class="row g-2 align-items-center mb-2">
            <div class="col-6 fw-semibold">History Period</div>
            <div class="col-6 text-end">
              <select id="historySelector" class="form-select form-select-sm ms-auto" style="width:auto;">
                <option value="1">Past 1 Hour</option>
                <option value="4">Past 4 Hours</option>
                <option value="8">Past 8 Hours</option>
                <option value="24">Past 24 Hours</option>
              </select>
            </div>
          </div>

          <div class="row g-2 align-items-center mb-2">
            <div class="col-6 fw-semibold">Forecast Period</div>
            <div class="col-6 text-end">
              <select id="periodSelector" class="form-select form-select-sm ms-auto" style="width:auto;">
                <option value="1">Next 1 Hour</option>
                <option value="4">Next 4 Hours</option>
                <option value="8">Next 8 Hours</option>
                <option value="24">Next 24 Hours</option>
              </select>
            </div>
          </div>

          <div class="row g-2 align-items-center mb-2">
            <div class="col-6 fw-semibold">Tariff Rate</div>
            <div class="col-6 text-end">
              <input id="tariffInput" type="number" step="0.01" class="form-control form-control-sm ms-auto" value="13.47" style="width:120px;">
            </div>
          </div>

          <div class="row g-2 align-items-center mb-2">
            <div class="col-6 fw-semibold">Budget</div>
            <div class="col-6 text-end">
              <input id="budgetInput" type="number" class="form-control form-control-sm ms-auto" value="300" style="width:120px;">
            </div>
          </div>

          <div class="row g-2 align-items-center mt-2">
            <div class="col-6 fw-semibold">Add Appliance</div>
            <div class="col-6 text-end d-flex justify-content-end gap-2">
              <button class="btn btn-outline-dark btn-sm rounded-circle" style="width:32px;height:32px;line-height:1;">+</button>
              <input class="form-control form-control-sm" value="Aircon" style="width:120px;">
            </div>
          </div>

          <div id="budgetAlert" class="d-none"></div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card p-3 h-100">
          <h5 class="mb-3">Appliances Consumption Ranking</h5>

          <div class="ranking-row mb-2">
            <div class="fw-semibold">Air Conditioner</div>
            <div class="d-flex gap-2">
              <span class="pill kwh-pill" id="acKwh">-- kWh</span>
              <span class="pill php-pill" id="acCost">--</span>
            </div>
          </div>

          <div class="ranking-row mb-2">
            <div class="fw-semibold">Refrigerator</div>
            <div class="d-flex gap-2">
              <span class="pill kwh-pill" id="refKwh">-- kWh</span>
              <span class="pill php-pill" id="refCost">--</span>
            </div>
          </div>

          <div class="ranking-row mb-2">
            <div class="fw-semibold">Washing Machine</div>
            <div class="d-flex gap-2">
              <span class="pill kwh-pill" id="wmKwh">-- kWh</span>
              <span class="pill php-pill" id="wmCost">--</span>
            </div>
          </div>

          <hr class="my-3">

          <div class="ranking-row">
            <div class="fw-bold">Total</div>
            <div class="d-flex gap-2">
              <span class="pill kwh-pill" id="totalKwh">-- kWh</span>
              <span class="pill php-pill" id="totalPhp">-- PHP</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card p-3 h-100">
          <h5 class="mb-3">Energy Forecast Summary</h5>

          <div class="summary-row">
            <div>Next period</div>
            <div class="fw-bold"><span id="nextKwhSummary">--</span> kWh (<span id="nextPhpSummary">--</span>)</div>
          </div>

          <div class="summary-row">
            <div>Previous period</div>
            <div class="fw-bold"><span id="prevKwhSummary">--</span> kWh (<span id="prevPhpSummary">--</span>)</div>
          </div>

          <div class="summary-row">
            <div>Actual usage</div>
            <div class="fw-bold"><span id="actualKwhSummary">--</span> kWh (<span id="actualPhpSummary">--</span>)</div>
          </div>

          <div class="summary-row">
            <div>Top Appliance</div>
            <div class="fw-bold" id="topApplianceText">--</div>
          </div>

          <div class="summary-row">
            <div>Budget Status</div>
            <div class="fw-bold"><span class="status-dot"></span><span id="budgetStatusText">At-Risk</span></div>
          </div>

          <span id="selectedPeriodText" class="d-none">Next 1 Hour</span>

          <div class="mt-3">
            <div class="fw-semibold mb-2">Mobile Notification Preview</div>
            <div id="mobileAlertText" class="small"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  /**********************************************************************
   * ✅ FIX REQUESTED:
   * - GO BACK to 1-hour resolution (no 5-minute densifying)
   * - Show MORE x-axis labels (don’t auto-skip, rotate like mockup)
   * - Keep Actual vs Forecast OVERLAP on the SAME history range
   * - Forecast continues into the future
   **********************************************************************/

  // ✅ 1 hour = 1 point (original behavior)
  function generateApplianceForecast(points) {
    let ac = [], ref = [], wm = [];
    for (let i = 0; i < points; i++) {
      ac.push(2.2 + Math.random()*0.6);
      ref.push(1.1 + Math.random()*0.3);
      wm.push(0.7 + Math.random()*0.2);
    }
    return {ac, ref, wm};
  }

  // ✅ 1 label per hour (but formatted like your mockup)
  function generateLabels(forecastHours, lookbackHours) {
    const now = new Date();

    const prevPoints = Math.max(1, lookbackHours);
    const nextPoints = Math.max(1, forecastHours);

    let prevLabels = [], nextLabels = [];
    for (let i = prevPoints; i > 0; i--) prevLabels.push(formatHour(now, -i));
    for (let i = 0; i < nextPoints; i++) nextLabels.push(formatHour(now, i));

    return { prevLabels, nextLabels, prevPoints, nextPoints };
  }

  function formatHour(date, offsetHours) {
    const d = new Date(date);
    d.setHours(d.getHours() + offsetHours);

    const mm = String(d.getMonth() + 1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const yy = String(d.getFullYear()).slice(-2);
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');

    // "MM/DD/YY HH:mm"
    return `${mm}/${dd}/${yy} ${hh}:${mi}`;
  }

  function generateActual(points) {
    return Array(points).fill().map((_,i) => 4.2 + i*0.15 + Math.random()*0.8);
  }
  function generateForecastPast(points){
    return Array(points).fill().map((_,i)=> 4.1 + i*0.15 + Math.random()*0.9);
  }

  function fmt2(n){ return (Math.round(n*100)/100).toFixed(2); }

  let selectedPeriod = 1;
  let selectedLookback = 1;
  let tariff = 13.47;

  let labels = generateLabels(selectedPeriod, selectedLookback);

  // history data (hourly)
  let prevActualData = generateActual(labels.prevPoints);
  let prevForecastData = generateForecastPast(labels.prevPoints);

  // future data (hourly)
  let nextApplianceForecasts = generateApplianceForecast(labels.nextPoints);
  let nextForecastData = nextApplianceForecasts.ac.map((v,i) =>
      v + nextApplianceForecasts.ref[i] + nextApplianceForecasts.wm[i]);

  // ✅ Forecast overlaps history + continues into future (mockup behavior)
  let forecastSeries = [...prevForecastData, ...nextForecastData];

  var lineCtx = document.getElementById('energyLineChart').getContext('2d');
  var lineChart = new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: [...labels.prevLabels, ...labels.nextLabels],
      datasets: [
        {
          label: 'Actual',
          // history shown, future hidden (nulls)
          data: [...prevActualData, ...Array(labels.nextPoints).fill(null)],
          borderColor: '#0d6efd',
          borderWidth: 3,
          pointBackgroundColor: '#0d6efd',
          fill: false,
          tension: 0.35
        },
        {
          label: 'Forecast',
          // ✅ overlaps and continues
          data: forecastSeries,
          borderColor: 'orange',
          borderWidth: 3,
          pointBackgroundColor: 'orange',
          fill: false,
          tension: 0.25
        }
      ]
    },
    options: {
      plugins: { legend: { display: false }},
      responsive: true,
      maintainAspectRatio: false,
      spanGaps: true,
      scales: {
        x: {
          grid: { color: "#dee2e6" },
          ticks: {
            color: "#495057",
            autoSkip: false,  // ✅ show all hourly labels (more labels vs before)
            maxRotation: 55,
            minRotation: 55
          }
        },
        y: {
          grid: { color: "#dee2e6" },
          beginAtZero: true,
          ticks: { color: "#495057" }
        }
      }
    }
  });

  var barCtx = document.getElementById('energyBarChart').getContext('2d');
  var barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: ["Previous", "Forecast"],
      datasets: [{
        label: 'Usage',
        data: [
          prevActualData.reduce((a,b)=>(b||0)+a,0),
          nextForecastData.reduce((a,b)=>(b||0)+a,0)
        ],
        backgroundColor: ["#198754", "orange"]
      }]
    },
    options: {
      plugins: { legend: { display: false }},
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { grid: { color: "#ddd" }},
        y: { beginAtZero: true, grid: { color:"#ddd" } }
      }
    }
  });

  function updateUI(periodHours, lookbackHours) {
    tariff = parseFloat(document.getElementById('tariffInput').value) || 13.47;

    labels = generateLabels(periodHours, lookbackHours);

    prevActualData = generateActual(labels.prevPoints);
    prevForecastData = generateForecastPast(labels.prevPoints);

    nextApplianceForecasts = generateApplianceForecast(labels.nextPoints);
    nextForecastData = nextApplianceForecasts.ac.map((v,i) =>
      v + nextApplianceForecasts.ref[i] + nextApplianceForecasts.wm[i]);

    forecastSeries = [...prevForecastData, ...nextForecastData];

    // Update line chart
    lineChart.data.labels = [...labels.prevLabels, ...labels.nextLabels];
    lineChart.data.datasets[0].data = [...prevActualData, ...Array(labels.nextPoints).fill(null)];
    lineChart.data.datasets[1].data = forecastSeries;
    lineChart.update();

    // Totals
    const prevTotal = prevActualData.reduce((a,b)=>(b||0)+a,0);
    const nextTotal = nextForecastData.reduce((a,b)=>(b||0)+a,0);

    // Update bar chart
    barChart.data.datasets[0].data = [prevTotal, nextTotal];
    barChart.update();

    // Costs
    const prevCost = prevTotal * tariff;
    const nextCost = nextTotal * tariff;

    let text =
      (periodHours == 1) ? "Next 1 Hour"
      : (periodHours == 4) ? "Next 4 Hours"
      : (periodHours == 8) ? "Next 8 Hours"
      : "Next 24 Hours";
    document.getElementById('selectedPeriodText').textContent = text;

    let budget = parseInt(document.getElementById('budgetInput').value);
    let status = (nextCost < budget) ? "OK" : (nextCost == budget) ? "At-Risk" : "At-Risk";
    document.getElementById('budgetStatusText').textContent = status;

    // Appliance kWh + PHP
    const acKwh = nextApplianceForecasts.ac.reduce((a,b)=>a+b,0);
    const refKwh = nextApplianceForecasts.ref.reduce((a,b)=>a+b,0);
    const wmKwh = nextApplianceForecasts.wm.reduce((a,b)=>a+b,0);

    const acPhp = acKwh * tariff;
    const refPhp = refKwh * tariff;
    const wmPhp = wmKwh * tariff;

    document.getElementById('acKwh').textContent = fmt2(acKwh) + " kWh";
    document.getElementById('refKwh').textContent = fmt2(refKwh) + " kWh";
    document.getElementById('wmKwh').textContent = fmt2(wmKwh) + " kWh";

    document.getElementById('acCost').textContent = Math.round(acPhp) + " PHP";
    document.getElementById('refCost').textContent = Math.round(refPhp) + " PHP";
    document.getElementById('wmCost').textContent = Math.round(wmPhp) + " PHP";

    const totalKwh = acKwh + refKwh + wmKwh;
    const totalPhp = acPhp + refPhp + wmPhp;
    document.getElementById('totalKwh').textContent = fmt2(totalKwh) + " kWh";
    document.getElementById('totalPhp').textContent = Math.round(totalPhp) + " PHP";

    const top =
      acPhp >= refPhp && acPhp >= wmPhp ? "Air Conditioner" :
      refPhp >= acPhp && refPhp >= wmPhp ? "Refrigerator" : "Washing Machine";
    document.getElementById('topApplianceText').textContent = top;

    document.getElementById('nextKwhSummary').textContent = fmt2(nextTotal);
    document.getElementById('nextPhpSummary').textContent = "₱" + fmt2(nextCost);

    document.getElementById('prevKwhSummary').textContent = fmt2(prevTotal);
    document.getElementById('prevPhpSummary').textContent = "₱" + fmt2(prevCost);

    document.getElementById('actualKwhSummary').textContent = fmt2(prevTotal);
    document.getElementById('actualPhpSummary').textContent = "₱" + fmt2(prevCost);

    document.getElementById('mobileAlertText').innerHTML =
      `"Your forecasted energy cost for ${text.toLowerCase()} is <strong>${Math.round(nextCost)} PHP</strong>. Previous period cost: <strong>${Math.round(prevCost)} PHP</strong>. Top-consuming appliance: <strong>${top}</strong>. Budget status: <strong>${status}</strong>."`;
  }

  document.getElementById('periodSelector').addEventListener('change', function() {
    selectedPeriod = parseInt(this.value);
    updateUI(selectedPeriod, selectedLookback);
  });
  document.getElementById('historySelector').addEventListener('change', function() {
    selectedLookback = parseInt(this.value);
    updateUI(selectedPeriod, selectedLookback);
  });
  document.getElementById('tariffInput').addEventListener('input', function() {
    updateUI(selectedPeriod, selectedLookback);
  });
  document.getElementById('budgetInput').addEventListener('input', function() {
    updateUI(selectedPeriod, selectedLookback);
  });

  updateUI(selectedPeriod, selectedLookback);
</script>
</body>
</html>